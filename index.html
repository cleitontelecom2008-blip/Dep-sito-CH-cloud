<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CH Geladas | Enterprise v2.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #3b82f6;
            --bg-dark: #07090e;
            --input-bg: #111827;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .input-field {
            background-color: var(--input-bg);
            border: 1px solid #1f2937;
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            color: white;
            font-size: 0.9rem;
        }

        .input-field:focus { border-color: var(--primary); }

        .label-blue {
            color: #3b82f6;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.4rem;
            display: block;
            margin-left: 0.5rem;
        }

        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .btn-active { 
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        #lock-screen { 
            position: fixed; inset: 0; z-index: 9999; 
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #07090e 100%);
            display: flex; align-items: center; justify-content: center; 
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        .admin-only-ui { display: none !important; }
        body.is-admin .admin-only-ui { display: block !important; }
        body.is-admin .admin-only-flex { display: flex !important; }

        .drop-zone { border: 2px dashed #3b82f6; transition: all 0.3s; }
        .drop-zone:hover { background: rgba(59, 130, 246, 0.1); }

        /* Anima√ß√£o de confirma√ß√£o ao adicionar ao carrinho */
        @keyframes cartFlash {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59,130,246,0.7); }
            30% { transform: scale(0.94); box-shadow: 0 0 0 8px rgba(59,130,246,0.3); }
            60% { transform: scale(1.04); box-shadow: 0 0 0 12px rgba(59,130,246,0); }
            100% { transform: scale(1); box-shadow: none; }
        }
        @keyframes cartFlashPack {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245,158,11,0.7); }
            30% { transform: scale(0.94); box-shadow: 0 0 0 8px rgba(245,158,11,0.3); }
            60% { transform: scale(1.04); box-shadow: 0 0 0 12px rgba(245,158,11,0); }
            100% { transform: scale(1); box-shadow: none; }
        }
        .btn-flash-un { animation: cartFlash 0.45s ease-out forwards; }
        .btn-flash-pack { animation: cartFlashPack 0.45s ease-out forwards; }

        /* Badge de confirma√ß√£o no carrinho */
        @keyframes badgePop {
            0% { transform: scale(0); opacity:0; }
            60% { transform: scale(1.3); opacity:1; }
            100% { transform: scale(1); opacity:1; }
        }
        #cartBadge { animation: badgePop 0.3s ease-out forwards; }

        /* Cards de produto mais vis√≠veis */
        .produto-card {
            background: linear-gradient(135deg, rgba(15,23,42,0.95) 0%, rgba(10,16,30,0.98) 100%);
            border: 1px solid rgba(255,255,255,0.07);
            border-left: 4px solid #3b82f6;
            border-radius: 1.25rem;
            transition: all 0.2s;
        }
        .produto-card:hover { border-color: rgba(59,130,246,0.6); background: rgba(15,23,42,1); }
        .produto-card .prod-nome { font-size: 0.78rem; font-weight: 800; color: #e2e8f0; letter-spacing: 0.02em; }
        .produto-card .prod-stock { font-size: 0.68rem; color: #64748b; font-weight: 700; }
        .produto-card .prod-stock.low { color: #ef4444; }
        .btn-unid {
            background: rgba(59,130,246,0.12);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 0.75rem;
            padding: 0.6rem 0.5rem;
            flex: 1;
            transition: all 0.15s;
            cursor: pointer;
            min-width: 0;
        }
        .btn-unid:hover { background: rgba(59,130,246,0.25); border-color: rgba(59,130,246,0.5); }
        .btn-unid:active { transform: scale(0.95); }
        .btn-pack {
            background: rgba(245,158,11,0.12);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 0.75rem;
            padding: 0.6rem 0.5rem;
            flex: 1;
            transition: all 0.15s;
            cursor: pointer;
            min-width: 0;
        }
        .btn-pack:hover { background: rgba(245,158,11,0.25); border-color: rgba(245,158,11,0.5); }
        .btn-pack:active { transform: scale(0.95); }

        /* Modal edi√ß√£o inline de produto no estoque */
        #modalEditProduto .modal-body { max-height: 85vh; overflow-y: auto; }

        /* Carrinho com indicador de adi√ß√£o */
        #carrinhoContainer { position: relative; }
        #cartAddIndicator {
            position: absolute;
            top: -10px; right: -10px;
            background: #3b82f6;
            color: white;
            border-radius: 999px;
            width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #cartAddIndicator.show { opacity: 1; }

        /* Novo item no carrinho com highlight */
        .carrinho-item-new {
            animation: newItemSlide 0.35s ease-out;
        }
        @keyframes newItemSlide {
            from { opacity:0; transform: translateX(20px) scale(0.95); background: rgba(59,130,246,0.2); }
            to { opacity:1; transform: translateX(0) scale(1); background: transparent; }
        }
    </style>
</head>
<body class="min-h-screen">

    <audio id="audioVenda" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

    <!-- Tela de Bloqueio -->
    <div id="lock-screen">
        <div class="text-center p-10 glass rounded-[3rem] w-full max-w-sm mx-4 shadow-2xl border border-white/10">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                <i class="fas fa-key text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-black mb-8 uppercase italic tracking-tighter">CH <span class="text-blue-500">GELADAS</span></h1>
            <input type="password" id="masterPass" maxlength="6" inputmode="numeric" class="w-full bg-slate-900 border border-slate-700 p-5 rounded-2xl text-center text-3xl mb-6 outline-none text-white tracking-[0.5em]" placeholder="‚Ä¢‚Ä¢‚Ä¢" onkeyup="checkPin(this.value)">
            <button onclick="login()" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase text-xs transition-all hover:bg-blue-500">Aceder ao Sistema</button>
            <p class="text-[9px] text-slate-500 mt-6 uppercase tracking-widest font-bold">Seguran√ßa Local Enterprise</p>
        </div>
    </div>

    <!-- Modal P√≥s Venda -->
    <div id="modalPosVenda" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-md mx-4 text-center border border-white/10 shadow-2xl transform transition-all scale-100">
            <div class="w-16 h-16 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-2">Venda Realizada!</h2>
            <p class="text-emerald-400 text-[10px] font-bold uppercase mb-1 tracking-wider"><i class="fas fa-save mr-1"></i> Arquivo Salvo no PC</p>
            <p class="text-slate-400 text-sm mb-8">O que deseja fazer agora?</p>
            
            <button onclick="enviarWhatsappUltimaVenda()" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white py-4 rounded-xl font-black uppercase text-xs mb-3 flex items-center justify-center gap-2 transition-all">
                <i class="fab fa-whatsapp text-lg"></i> Enviar Comprovante
            </button>
            <button onclick="fecharModalPosVenda()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-4 rounded-xl font-black uppercase text-xs transition-all">
                Nova Venda
            </button>
        </div>
    </div>

    <!-- Modal Config WhatsApp -->
    <div id="modalConfigZap" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm mx-4 border border-white/10 shadow-2xl">
            <h3 class="label-blue mb-6 !text-sm">Configura√ß√£o WhatsApp</h3>
            <p class="text-xs text-slate-400 mb-4">Insira o n√∫mero com o c√≥digo do pa√≠s e DDD (apenas n√∫meros). Ex: 5511999999999</p>
            <input type="tel" id="zapNumberInput" class="input-field mb-6" placeholder="55..." inputmode="numeric">
            <div class="flex gap-3">
                <button onclick="salvarConfigZap()" class="flex-1 bg-blue-600 py-3 rounded-xl font-black uppercase text-xs">Salvar</button>
                <button onclick="toggleModal('modalConfigZap')" class="flex-1 bg-slate-800 py-3 rounded-xl font-black uppercase text-xs text-slate-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Venda -->
    <div id="modalEditVenda" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm mx-4 border border-white/10 shadow-2xl">
            <h3 class="label-blue mb-6 !text-sm text-amber-500">Editar Venda</h3>
            <input type="hidden" id="editVendaId">
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="label-blue">Data/Hora (Texto)</label>
                    <input type="text" id="editVendaData" class="input-field">
                </div>
                <div>
                    <label class="label-blue">Total (R$)</label>
                    <input type="number" id="editVendaTotal" class="input-field" step="0.01">
                </div>
                 <div>
                    <label class="label-blue">Lucro Estimado (R$)</label>
                    <input type="number" id="editVendaLucro" class="input-field" step="0.01">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="salvarEdicaoVenda()" class="flex-1 bg-amber-600 hover:bg-amber-500 py-3 rounded-xl font-black uppercase text-xs text-white">Atualizar</button>
                <button onclick="toggleModal('modalEditVenda')" class="flex-1 bg-slate-800 py-3 rounded-xl font-black uppercase text-xs text-slate-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Produto (Estoque) -->
    <div id="modalEditProduto" class="modal-overlay">
        <div class="glass rounded-[2.5rem] w-full max-w-md mx-4 border border-white/10 shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <h3 class="text-sm font-black uppercase tracking-wider text-blue-400"><i class="fas fa-edit mr-2"></i>Editar Produto</h3>
                <button onclick="toggleModal('modalEditProduto')" class="w-8 h-8 rounded-lg bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <input type="hidden" id="modalEditProdId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="label-blue">Nome do Produto</label>
                        <input type="text" id="modalEditNome" class="input-field" placeholder="Nome">
                    </div>
                    <div>
                        <label class="label-blue">Custo Compra (Un.)</label>
                        <input type="number" id="modalEditCusto" class="input-field" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label class="label-blue">Pre√ßo Venda (Un.)</label>
                        <input type="number" id="modalEditPreco" class="input-field" placeholder="0.00" step="0.01">
                    </div>
                    <div>
                        <label class="label-blue">Stock Atual (Un.)</label>
                        <div class="flex items-center gap-2">
                            <button onclick="ajustarModalStock(-1)" class="w-10 h-10 rounded-xl bg-slate-800 text-red-400 font-black text-lg border border-white/5 hover:bg-red-500/20 flex-shrink-0">‚àí</button>
                            <input type="number" id="modalEditQtd" class="input-field text-center font-black text-lg" placeholder="0">
                            <button onclick="ajustarModalStock(1)" class="w-10 h-10 rounded-xl bg-slate-800 text-emerald-400 font-black text-lg border border-white/5 hover:bg-emerald-500/20 flex-shrink-0">+</button>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <div class="w-full">
                            <label class="label-blue">Entrada R√°pida</label>
                            <div class="flex gap-2">
                                <input type="number" id="modalEntradaQtd" class="input-field text-center" placeholder="Qtd">
                                <button onclick="entradaRapidaModal()" class="bg-emerald-600/20 text-emerald-400 px-3 rounded-xl text-xs font-black border border-emerald-500/20 hover:bg-emerald-600/40 whitespace-nowrap">+ Stock</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Packs -->
                <div class="bg-black/20 p-5 rounded-2xl border border-white/5">
                    <h4 class="label-blue text-amber-400 mb-3"><i class="fas fa-box mr-1"></i>Packs de Venda</h4>
                    <div id="modalPacksList" class="space-y-2 mb-4"></div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="label-blue">Qtd Pack</label>
                            <input type="number" id="modalNewPackUn" class="input-field" placeholder="Ex: 6">
                        </div>
                        <div>
                            <label class="label-blue">Pre√ßo Pack</label>
                            <input type="number" id="modalNewPackPreco" class="input-field" placeholder="Ex: 15.00" step="0.01">
                        </div>
                    </div>
                    <button onclick="adicionarPackModal()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl font-bold text-[10px] uppercase border border-white/5 transition-all">
                        <i class="fas fa-plus mr-2 text-amber-400"></i>Adicionar Pack
                    </button>
                </div>
            </div>
            <div class="p-6 border-t border-white/5 flex gap-3">
                <button onclick="salvarEdicaoProduto()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase text-xs transition-all">
                    <i class="fas fa-check mr-2"></i>Guardar Altera√ß√µes
                </button>
                <button onclick="toggleModal('modalEditProduto')" class="bg-slate-800 hover:bg-slate-700 px-6 rounded-xl font-black uppercase text-xs text-slate-400 transition-all">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div id="app-content" class="hidden flex flex-col min-h-screen">
        <header class="bg-slate-900/50 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black text-sm shadow-lg shadow-blue-500/20">CH</div>
                <div>
                    <h2 class="text-[10px] font-black uppercase text-blue-500 tracking-widest leading-none mb-1" id="userRoleTitle">Acesso Verificado</h2>
                    <p id="liveClock" class="text-[10px] font-mono text-slate-500">00:00:00</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="location.reload()" title="Sair" class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white">
                    <i class="fas fa-power-off text-xs"></i>
                </button>
            </div>
        </header>

        <!-- Navega√ß√£o -->
        <nav class="bg-slate-950 border-b border-white/5 flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('vendas')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase btn-active" data-tab="vendas">Vendas</button>
            <button onclick="switchTab('estoque')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="estoque">Estoque</button>
            <button onclick="switchTab('financeiro')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="financeiro">Financeiro</button>
            <button onclick="switchTab('ponto')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase" data-tab="ponto">Ponto</button>
            <button onclick="switchTab('dados')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="dados">Dados</button>
        </nav>

        <main class="flex-1 p-4 lg:p-6 max-w-7xl mx-auto w-full">
            
            <!-- PDV / Vendas -->
            <section id="vendas" class="tab-content active">
                <div class="grid lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-8 flex flex-col gap-4">
                        <div class="flex gap-2">
                            <input type="text" id="searchProd" oninput="renderCatalogo()" class="input-field" placeholder="Pesquisar no stock...">
                            <button onclick="toggleModal('modalConfigZap')" class="w-14 bg-slate-800 rounded-2xl flex items-center justify-center text-slate-400 hover:text-[#25D366] hover:bg-slate-700 transition-colors border border-white/5" title="Configurar WhatsApp">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto custom-scroll max-h-[60vh]" id="catalogoVenda"></div>
                    </div>
                    
                    <div class="lg:col-span-4">
                        <div id="carrinhoContainer" class="glass p-6 rounded-[2.5rem] flex flex-col h-full sticky top-24 border border-white/5">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="label-blue !mb-0">Carrinho Atual</h3>
                                <span id="cartCountBadge" class="hidden bg-blue-500 text-white text-[9px] font-black rounded-full px-2 py-0.5 min-w-[22px] text-center">0</span>
                            </div>
                            <div id="carrinhoLista" class="flex-1 overflow-y-auto space-y-3 mb-6 custom-scroll min-h-[250px]"></div>
                            <div class="pt-6 border-t border-white/10 text-center">
                                <h2 id="displayCartTotal" class="text-4xl font-black text-blue-500 mb-4">R$ 0,00</h2>
                                <button onclick="finalizarVenda()" id="btnFinalizar" disabled class="w-full py-5 rounded-2xl bg-slate-800 text-slate-500 font-black uppercase text-[11px] transition-all">Finalizar Venda</button>
                                <p class="text-[8px] text-slate-500 mt-3 uppercase font-bold tracking-widest">Gera√ß√£o Autom√°tica de TXT ativada</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estoque -->
            <section id="estoque" class="tab-content">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-slate-900/40 p-8 rounded-[2.5rem] border border-white/5 mb-8">
                        <h3 class="label-blue mb-8" id="formEstoqueTitle">Novo Produto</h3>
                        <input type="hidden" id="editingProdId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="label-blue">Designa√ß√£o</label>
                                <input type="text" id="pNome" class="input-field" placeholder="Ex: Cerveja Especial">
                            </div>
                            <div>
                                <label class="label-blue">Custo Compra (Un.)</label>
                                <input type="number" id="pCustoUn" class="input-field" placeholder="0.00">
                            </div>
                            <div>
                                <label class="label-blue">Stock Inicial</label>
                                <input type="number" id="pQtdUn" class="input-field" placeholder="0">
                            </div>
                            <div>
                                <label class="label-blue">Pre√ßo Venda (Un.)</label>
                                <input type="number" id="pPrecoUn" class="input-field" placeholder="0.00">
                            </div>
                        </div>

                        <div class="bg-black/20 p-6 rounded-3xl border border-white/5">
                            <h4 class="label-blue mb-4 text-blue-400">Packs de Venda</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="number" id="tempPackUn" class="input-field" placeholder="Qtd (ex: 6)">
                                <input type="number" id="tempPackPreco" class="input-field" placeholder="Pre√ßo Pack">
                            </div>
                            <button onclick="addPackToList()" class="w-full bg-slate-800 text-slate-300 py-3 rounded-xl font-bold text-[10px] uppercase">Adicionar Pack</button>
                            <div id="tempPackList" class="mt-4 space-y-2"></div>
                        </div>

                        <div class="flex gap-4 mt-8">
                            <button id="btnSaveProd" onclick="saveProduto()" class="flex-1 bg-blue-600 py-5 rounded-2xl font-black uppercase text-xs">Registar Produto</button>
                            <button id="btnCancelEdit" onclick="resetFormEstoque()" class="hidden bg-slate-800 px-8 rounded-2xl font-black uppercase text-xs text-slate-400">Cancelar</button>
                        </div>
                    </div>
                    
                    <div id="gridEstoque" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </section>

            <!-- Financeiro -->
            <section id="financeiro" class="tab-content">
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-blue-500">
                        <span class="label-blue !ml-0">Investimento Total</span>
                        <input type="number" id="invTotalInput" onchange="updateInvestimento()" class="bg-transparent text-3xl font-black w-full outline-none text-white mt-2" placeholder="0.00">
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-emerald-500">
                        <span class="label-blue !ml-0">Lucro L√≠quido</span>
                        <h2 id="dashLucro" class="text-3xl font-black mt-2 text-emerald-400">R$ 0,00</h2>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-amber-500">
                        <span class="label-blue !ml-0">ROI Global</span>
                        <h2 id="roiDisplay" class="text-3xl font-black mt-2 text-amber-400">0%</h2>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-[2.5rem] flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="label-blue !ml-0">Hist√≥rico de Vendas</h3>
                            <span class="text-[9px] bg-blue-500/10 text-blue-500 px-2 py-1 rounded-lg font-bold" id="totalVendasCount">0 reg</span>
                        </div>
                        <div class="space-y-3 overflow-y-auto custom-scroll max-h-[500px]" id="vendaLogs"></div>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] h-fit sticky top-24">
                        <h3 class="label-blue !ml-0 mb-6">M√©tricas & A√ß√µes</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-black/20 rounded-2xl flex justify-between border border-white/5">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Fatura√ß√£o Bruta</span>
                                <span id="faturacaoBruta" class="font-black">R$ 0,00</span>
                            </div>
                            <div class="p-4 bg-black/20 rounded-2xl flex justify-between border border-white/5">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Status Break-Even</span>
                                <span id="breakEvenStatus" class="font-black text-amber-500">R$ 0,00</span>
                            </div>
                             <button onclick="exportarRelatorioTxt()" class="w-full bg-emerald-600/10 text-emerald-500 py-3 rounded-xl font-bold text-[10px] uppercase border border-emerald-500/20 hover:bg-emerald-600/20 mt-4">
                                <i class="fas fa-file-alt mr-2"></i> Baixar Relat√≥rio TXT
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ponto -->
            <section id="ponto" class="tab-content">
                <div class="max-w-xl mx-auto">
                    <div class="glass p-10 rounded-[3rem] text-center border border-white/5">
                        <h3 class="label-blue !ml-0 mb-6 italic">Folha de Ponto</h3>
                        <input type="text" id="workerName" class="input-field text-center mb-6" placeholder="Nome do Funcion√°rio">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="registarPonto('ENTRADA')" class="bg-emerald-600 p-5 rounded-2xl font-black uppercase text-[11px]">Entrada</button>
                            <button onclick="registarPonto('SA√çDA')" class="bg-red-600 p-5 rounded-2xl font-black uppercase text-[11px]">Sa√≠da</button>
                        </div>
                    </div>
                    <div id="pontoLogs" class="mt-8 space-y-2"></div>
                </div>
            </section>

             <!-- DADOS / BACKUP -->
            <section id="dados" class="tab-content">
                <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8">
                    <!-- Exportar -->
                    <div class="glass p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center mb-6 text-blue-500">
                            <i class="fas fa-cloud-download-alt text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-black uppercase mb-2">Exportar Dados</h3>
                        <p class="text-xs text-slate-400 mb-8 max-w-[200px]">Crie um arquivo de seguran√ßa com todo o estoque, vendas e configura√ß√µes.</p>
                        <button onclick="exportarBackup()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase text-xs hover:bg-blue-500 transition-all">
                            Baixar Backup (.json)
                        </button>
                        <p class="text-[9px] text-slate-500 mt-4 font-bold">√öLTIMO BACKUP: <span id="lastBackupInfo">Nunca</span></p>
                    </div>

                    <!-- Importar -->
                    <div class="glass p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center text-center drop-zone relative">
                        <div class="w-16 h-16 bg-emerald-600/20 rounded-full flex items-center justify-center mb-6 text-emerald-500">
                            <i class="fas fa-cloud-upload-alt text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-black uppercase mb-2">Importar Dados</h3>
                        <p class="text-xs text-slate-400 mb-8 max-w-[200px]">Carregue um arquivo .json para restaurar seus dados neste aparelho.</p>
                        
                        <!-- Input corrigido -->
                        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importarDados(this)">
                        
                        <button onclick="document.getElementById('fileInput').click()" class="w-full bg-emerald-600 py-4 rounded-xl font-black uppercase text-xs hover:bg-emerald-500 transition-all mb-3">
                            Selecionar Arquivo
                        </button>
                        <p class="text-[8px] text-red-400/60 font-bold uppercase tracking-widest"><i class="fas fa-exclamation-triangle mr-1"></i> Substitui dados atuais</p>
                    </div>
                    
                    <div class="md:col-span-2 glass p-6 rounded-[2rem] border border-white/5 text-center">
                         <h3 class="label-blue mb-4">Estat√≠sticas do Sistema</h3>
                         <div class="grid grid-cols-3 gap-4">
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Total Produtos</span>
                                 <span class="text-xl font-black" id="statProds">0</span>
                             </div>
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Total Vendas</span>
                                 <span class="text-xl font-black" id="statVendas">0</span>
                             </div>
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Registos Ponto</span>
                                 <span class="text-xl font-black" id="statPonto">0</span>
                             </div>
                         </div>
                    </div>

                    <!-- ZONA DE PERIGO / RESET -->
                    <div class="md:col-span-2 glass p-8 rounded-[2rem] border border-red-500/20 relative overflow-hidden group">
                        <div class="absolute inset-0 bg-red-500/5 group-hover:bg-red-500/10 transition-all"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6 text-center md:text-left">
                            <div>
                                <h3 class="text-lg font-black uppercase text-red-500 mb-1 flex items-center justify-center md:justify-start">
                                    <i class="fas fa-radiation mr-2"></i> Reset Geral
                                </h3>
                                <p class="text-[10px] text-slate-400 font-bold max-w-md">
                                    Esta a√ß√£o √© irrevers√≠vel. Apaga permanentemente todo o estoque, hist√≥rico de vendas, ponto e configura√ß√µes. Use com cautela.
                                </p>
                            </div>
                            <button onclick="resetSistema()" class="bg-red-500/10 text-red-500 border border-red-500/50 py-4 px-8 rounded-xl font-black uppercase text-xs hover:bg-red-600 hover:text-white hover:border-red-600 transition-all whitespace-nowrap shadow-lg shadow-red-500/10">
                                <i class="fas fa-trash-alt mr-2"></i> Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 glass px-8 py-5 rounded-2xl flex items-center gap-4 z-[100] transition-all opacity-0 translate-y-20 pointer-events-none">
        <div id="toastIcon"></div>
        <div class="flex flex-col"><span class="text-[11px] font-black uppercase" id="toastMsg"></span><span class="text-[9px] text-slate-500 font-bold uppercase" id="toastSubMsg"></span></div>
    </div>

    <!-- Bot√£o flutuante do carrinho (mobile) -->
    <button id="floatingCartBtn" onclick="scrollToCarrinho()" 
        class="lg:hidden fixed bottom-6 right-6 z-50 bg-blue-600 text-white rounded-2xl px-5 py-4 font-black text-xs uppercase shadow-xl shadow-blue-500/30 border border-blue-400/20 transition-all opacity-0 pointer-events-none flex items-center gap-3"
        style="transition: opacity 0.3s, transform 0.3s;">
        <i class="fas fa-shopping-cart text-base"></i>
        <div class="flex flex-col items-start leading-none">
            <span id="floatingCartCount" class="text-[9px] text-blue-200">0 itens</span>
            <span id="floatingCartTotal" class="text-sm font-black">R$ 0,00</span>
        </div>
    </button>

    <script>
        const STORAGE_KEY = 'CH_GELADAS_DB_ENTERPRISE';
        let db = { estoque: [], vendas: [], ponto: [], investimento: 0, config: { whatsapp: '' } };
        let carrinho = [];
        let tempPacks = [];
        let isAdmin = false;
        let lastSale = null;

        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                db = { ...db, ...parsed };
                // Garantir estrutura da config
                if(!db.config) db.config = { whatsapp: '' };
            }
            
            // Garantir arrays
            if(!db.estoque) db.estoque = [];
            if(!db.vendas) db.vendas = [];
            if(!db.ponto) db.ponto = [];
            
            document.getElementById('invTotalInput').value = db.investimento || 0;
            document.getElementById('zapNumberInput').value = db.config.whatsapp || '';

            updateClock(); setInterval(updateClock, 1000);
            updateStats();
            refreshUI();
        }

        function checkPin(val) {
            if(val === "001" || val === "12345") login();
        }

        function login() {
            const pin = document.getElementById('masterPass').value;
            if(pin === "001") {
                isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('userRoleTitle').textContent = "ADMINISTRADOR";
            } else if(pin === "12345") {
                isAdmin = false;
                document.body.classList.remove('is-admin');
                document.getElementById('userRoleTitle').textContent = "COLABORADOR";
            } else { return; }

            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-content').classList.remove('hidden');
            showToast("Acesso OK", "Sess√£o iniciada");
        }

        function switchTab(id) {
            const btn = document.querySelector(`[data-tab="${id}"]`);
            if(btn.classList.contains('admin-only-ui') && !isAdmin) {
                showToast("Negado", "Apenas Administrador", "error");
                return;
            }
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('btn-active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('btn-active');
            
            if(id === 'estoque') resetFormEstoque();
            if(id === 'dados') updateStats();
            if(id === 'financeiro') renderFinanceiro();
        }

        // --- WHATSAPP CONFIG ---
        function toggleModal(id, forceClose = false) {
            const el = document.getElementById(id);
            if(forceClose) {
                el.classList.remove('open');
            } else {
                el.classList.toggle('open');
            }
        }

        function salvarConfigZap() {
            const num = document.getElementById('zapNumberInput').value.replace(/\D/g,'');
            db.config.whatsapp = num;
            save();
            toggleModal('modalConfigZap');
            showToast("Configura√ß√£o", "N√∫mero WhatsApp Salvo");
        }

        function enviarWhatsappUltimaVenda() {
            if(!lastSale || !db.config.whatsapp) {
                if(!db.config.whatsapp) showToast("Erro", "Configure o WhatsApp na aba Vendas", "error");
                return;
            }
            
            let msg = `*CH GELADAS | COMPROVANTE*\n`;
            msg += `üìÖ ${lastSale.data}\n`;
            msg += `--------------------------\n`;
            lastSale.itens.forEach(item => {
                msg += `${item.label === 'UNID' ? '1x' : item.label} ${item.nome} ... R$ ${item.preco.toFixed(2)}\n`;
            });
            msg += `--------------------------\n`;
            msg += `*TOTAL: R$ ${lastSale.total.toFixed(2)}*\n`;
            msg += `Obrigado pela prefer√™ncia!`;

            const url = `https://wa.me/${db.config.whatsapp}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
            fecharModalPosVenda();
        }

        function fecharModalPosVenda() {
            toggleModal('modalPosVenda', true);
        }

        // --- ESTOQUE ---
        function addPackToList() {
            const un = parseInt(document.getElementById('tempPackUn').value);
            const preco = parseFloat(document.getElementById('tempPackPreco').value);
            if(!un || !preco) return;
            tempPacks.push({ un, preco });
            document.getElementById('tempPackUn').value = "";
            document.getElementById('tempPackPreco').value = "";
            renderTempPacks();
        }

        function renderTempPacks() {
            const cont = document.getElementById('tempPackList');
            cont.innerHTML = tempPacks.map((p, i) => `
                <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                    <span class="text-[10px] font-bold">Pack ${p.un} UN -> R$ ${p.preco.toFixed(2)}</span>
                    <button onclick="tempPacks.splice(${i},1); renderTempPacks();" class="text-red-500 text-xs px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function saveProduto() {
            const nome = document.getElementById('pNome').value;
            const custoUn = parseFloat(document.getElementById('pCustoUn').value) || 0;
            const qtdUn = parseInt(document.getElementById('pQtdUn').value) || 0;
            const precoUn = parseFloat(document.getElementById('pPrecoUn').value) || 0;
            const editId = document.getElementById('editingProdId').value;

            if(!nome) return showToast("Erro", "Nome obrigat√≥rio", "error");

            if(editId) {
                // Modo Edi√ß√£o
                const idx = db.estoque.findIndex(p => p.id == editId);
                if(idx !== -1) {
                    db.estoque[idx] = { ...db.estoque[idx], nome, custoUn, qtdUn, precoUn, packs: [...tempPacks] };
                    showToast("Sucesso", "Produto Atualizado");
                }
            } else {
                // Novo Produto
                db.estoque.unshift({ id: Date.now(), nome, custoUn, qtdUn, precoUn, packs: [...tempPacks] });
                showToast("Estoque", "Produto Registado");
            }

            resetFormEstoque();
            save();
        }

        function editProduto(id) {
            const p = db.estoque.find(x => x.id == id);
            if(!p) return;

            document.getElementById('formEstoqueTitle').textContent = "Editar Produto";
            document.getElementById('editingProdId').value = p.id;
            document.getElementById('pNome').value = p.nome;
            document.getElementById('pCustoUn').value = p.custoUn;
            document.getElementById('pQtdUn').value = p.qtdUn;
            document.getElementById('pPrecoUn').value = p.precoUn;
            tempPacks = [...p.packs];
            renderTempPacks();

            document.getElementById('btnSaveProd').textContent = "Atualizar Produto";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            switchTab('estoque');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormEstoque() {
            document.getElementById('formEstoqueTitle').textContent = "Novo Produto";
            document.getElementById('editingProdId').value = "";
            ['pNome', 'pCustoUn', 'pQtdUn', 'pPrecoUn'].forEach(id => document.getElementById(id).value = "");
            tempPacks = [];
            document.getElementById('tempPackList').innerHTML = "";
            document.getElementById('btnSaveProd').textContent = "Registar Produto";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        // Fun√ß√£o r√°pida de ajuste de estoque (Adicionar/Remover Mercearia)
        function quickStockAction(id, type) {
            const prod = db.estoque.find(x => x.id === id);
            if(!prod) return;

            const actionText = type === 'add' ? 'ADICIONAR' : 'REMOVER';
            const input = prompt(`${actionText} quantidade para: ${prod.nome}\n(Estoque Atual: ${prod.qtdUn})`);
            
            if(input !== null) {
                const qtd = parseInt(input);
                if(!isNaN(qtd) && qtd > 0) {
                    if(type === 'add') {
                        prod.qtdUn += qtd;
                        showToast("Entrada", `+${qtd} em ${prod.nome}`);
                    } else {
                        prod.qtdUn -= qtd;
                        showToast("Sa√≠da", `-${qtd} em ${prod.nome}`, "warning");
                    }
                    save();
                } else {
                    showToast("Cancelado", "Valor inv√°lido", "error");
                }
            }
        }

        // --- VENDAS ---
        function renderCatalogo() {
            const search = document.getElementById('searchProd').value.toLowerCase();
            const cont = document.getElementById('catalogoVenda');
            const filtered = db.estoque.filter(p => p.nome.toLowerCase().includes(search));
            cont.innerHTML = filtered.map(p => {
                const stockLow = p.qtdUn <= 3;
                const stockZero = p.qtdUn <= 0;
                return `
                <div class="produto-card p-4" id="card-prod-${p.id}">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <p class="prod-nome">${p.nome}</p>
                            <p class="prod-stock ${stockLow ? 'low' : ''}">
                                <i class="fas fa-box-open mr-1"></i>
                                ${stockZero ? 'SEM STOCK' : `${p.qtdUn} un. dispon√≠veis`}
                                ${stockLow && !stockZero ? '‚ö†Ô∏è' : ''}
                            </p>
                        </div>
                        <span class="text-[9px] font-black px-2 py-1 rounded-lg ${stockZero ? 'bg-red-500/20 text-red-400' : stockLow ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}">
                            ${stockZero ? 'ESGOT.' : stockLow ? 'BAIXO' : 'OK'}
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="btn-un-${p.id}" onclick="addAoCarrinho(${p.id}, 0, this)" class="btn-unid ${stockZero ? 'opacity-40 cursor-not-allowed' : ''}">
                            <span class="block text-[8px] font-black text-blue-400 mb-0.5">UNID.</span>
                            <span class="text-sm font-black text-white">R$ ${p.precoUn.toFixed(2)}</span>
                        </button>
                        ${p.packs.map((pack, idx) => {
                            const semStock = p.qtdUn < pack.un;
                            return `
                            <button id="btn-pack-${p.id}-${idx}" onclick="addAoCarrinho(${p.id}, ${idx + 1}, this)" class="btn-pack ${semStock ? 'opacity-40 cursor-not-allowed' : ''}">
                                <span class="block text-[8px] font-black text-amber-500 mb-0.5">PACK ${pack.un}x</span>
                                <span class="text-sm font-black text-white">R$ ${pack.preco.toFixed(2)}</span>
                            </button>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function addAoCarrinho(prodId, packIdx, btnEl) {
            const p = db.estoque.find(x => x.id === prodId);
            let item = { prodId: p.id, nome: p.nome };
            if(packIdx === 0) {
                if(p.qtdUn < 1) return showToast("Sem Stock", p.nome, "error");
                item.label = "UNID"; item.preco = p.precoUn; item.custo = p.custoUn; item.desconto = 1;
            } else {
                const pack = p.packs[packIdx - 1];
                if(p.qtdUn < pack.un) return showToast("Stock Insuficiente", "Pack cancelado", "error");
                item.label = `PACK ${pack.un}`; item.preco = pack.preco; item.custo = p.custoUn * pack.un; item.desconto = pack.un;
            }
            carrinho.push(item);
            renderCarrinho();

            // Anima√ß√£o no bot√£o
            if(btnEl) {
                const cls = packIdx === 0 ? 'btn-flash-un' : 'btn-flash-pack';
                btnEl.classList.remove(cls);
                void btnEl.offsetWidth; // reflow para reiniciar
                btnEl.classList.add(cls);
                setTimeout(() => btnEl.classList.remove(cls), 500);
            }

            // Scroll para o carrinho em desktop; mostra bot√£o flutuante em mobile
            atualizarBotaoFlutuante();
            
            // Em ecr√£s pequenos, se o carrinho n√£o est√° vis√≠vel, pisca o bot√£o flutuante
            const isMobile = window.innerWidth < 1024;
            if(isMobile) {
                const floatBtn = document.getElementById('floatingCartBtn');
                floatBtn.style.transform = 'scale(1.1)';
                setTimeout(() => floatBtn.style.transform = 'scale(1)', 200);
            }
        }

        function renderCarrinho() {
            const cont = document.getElementById('carrinhoLista');
            if(carrinho.length === 0) {
                cont.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center opacity-30 py-8">
                    <i class="fas fa-shopping-cart text-3xl mb-3 text-slate-500"></i>
                    <p class="text-[10px] text-slate-500 font-bold uppercase">Carrinho vazio</p>
                </div>`;
            } else {
                cont.innerHTML = carrinho.map((c, idx) => `
                    <div class="flex justify-between items-center bg-slate-950/80 p-4 rounded-2xl border border-white/5 ${idx === carrinho.length - 1 ? 'carrinho-item-new' : ''}">
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black text-slate-400 uppercase">${c.nome}</span>
                            <span class="text-xs font-black text-blue-500">${c.label} ‚Ä¢ <span class="text-white">R$ ${c.preco.toFixed(2)}</span></span>
                        </div>
                        <button onclick="removerDoCarrinho(${idx})" class="text-red-500/50 hover:text-red-400 p-2 transition-colors"><i class="fas fa-trash text-xs"></i></button>
                    </div>`).join('');
            }
            const total = carrinho.reduce((a, b) => a + b.preco, 0);
            document.getElementById('displayCartTotal').textContent = `R$ ${total.toLocaleString('pt-PT', {minimumFractionDigits:2})}`;
            
            // Badge contador
            const badge = document.getElementById('cartCountBadge');
            if(carrinho.length > 0) {
                badge.textContent = carrinho.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const btn = document.getElementById('btnFinalizar');
            btn.disabled = carrinho.length === 0;
            btn.className = `w-full py-5 rounded-2xl font-black uppercase text-[11px] ${carrinho.length > 0 ? 'bg-blue-600 text-white shadow-xl shadow-blue-500/20 hover:bg-blue-500' : 'bg-slate-800 text-slate-500'}`;

            atualizarBotaoFlutuante();
        }

        function removerDoCarrinho(idx) {
            carrinho.splice(idx, 1);
            renderCarrinho();
            atualizarBotaoFlutuante();
        }

        function atualizarBotaoFlutuante() {
            const total = carrinho.reduce((a, b) => a + b.preco, 0);
            const floatBtn = document.getElementById('floatingCartBtn');
            const floatCount = document.getElementById('floatingCartCount');
            const floatTotal = document.getElementById('floatingCartTotal');
            if(carrinho.length > 0) {
                floatCount.textContent = `${carrinho.length} ${carrinho.length === 1 ? 'item' : 'itens'}`;
                floatTotal.textContent = `R$ ${total.toLocaleString('pt-PT', {minimumFractionDigits:2})}`;
                floatBtn.style.opacity = '1';
                floatBtn.style.pointerEvents = 'auto';
            } else {
                floatBtn.style.opacity = '0';
                floatBtn.style.pointerEvents = 'none';
            }
        }

        function scrollToCarrinho() {
            const el = document.getElementById('carrinhoContainer');
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function finalizarVenda() {
            try { document.getElementById('audioVenda').play(); } catch(e){}
            const total = carrinho.reduce((a, b) => a + b.preco, 0);
            const lucro = carrinho.reduce((a, b) => a + (b.preco - b.custo), 0);
            
            carrinho.forEach(item => {
                const p = db.estoque.find(x => x.id === item.prodId);
                if(p) p.qtdUn -= item.desconto;
            });

            const vendaObj = { 
                id: Date.now(),
                total, 
                lucro, 
                data: new Date().toLocaleString('pt-PT'), 
                itens: [...carrinho] 
            };

            db.vendas.unshift(vendaObj);
            lastSale = vendaObj;
            
            carrinho = [];
            save();
            renderCarrinho(); 
            
            // 1. Salvar Autom√°tico TXT
            salvarVendaTxt(vendaObj);

            // 2. Abrir Modal com op√ß√£o de WhatsApp
            toggleModal('modalPosVenda');
        }

        function salvarVendaTxt(v) {
            let txt = `CH GELADAS - CUPOM N√ÉO FISCAL\n`;
            txt += `ID: ${v.id} | Data: ${v.data}\n`;
            txt += `--------------------------------\n`;
            v.itens.forEach(i => {
                txt += `${i.label === 'UNID' ? '1x' : i.label} ${i.nome} ... R$ ${i.preco.toFixed(2)}\n`;
            });
            txt += `--------------------------------\n`;
            txt += `TOTAL: R$ ${v.total.toFixed(2)}\n`;
            
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Venda_${v.id}.txt`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportarRelatorioTxt() {
            if (!db.vendas || db.vendas.length === 0) return showToast("Aviso", "Sem vendas para exportar");
            let conteudo = "--- RELAT√ìRIO DE VENDAS CH GELADAS ---\n";
            conteudo += `Gerado em: ${new Date().toLocaleString('pt-PT')}\n\n`;
            db.vendas.forEach((v, i) => {
                conteudo += `VENDA #${v.id} | DATA: ${v.data}\n`;
                v.itens.forEach(item => { conteudo += `- ${item.nome} (${item.label}): R$ ${item.preco.toFixed(2)}\n`; });
                conteudo += `TOTAL: R$ ${v.total.toFixed(2)}\n--------------------------------------\n`;
            });
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vendas_ch_geladas_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // --- FINANCEIRO AVAN√áADO ---
        function renderFinanceiro() {
            const container = document.getElementById('vendaLogs');
            document.getElementById('totalVendasCount').textContent = `${db.vendas.length} reg`;
            
            container.innerHTML = db.vendas.map(v => `
                <div class="bg-black/20 p-4 rounded-2xl flex justify-between items-center group transition-all hover:bg-slate-900/80 border border-white/5">
                    <div class="flex flex-col gap-1">
                        <span class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">${v.data}</span>
                        <div class="flex items-center gap-2">
                             <span class="text-sm font-black text-white">R$ ${v.total.toFixed(2)}</span>
                             <span class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">${v.itens.length} itens</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="abrirEditorVenda(${v.id})" class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="excluirVenda(${v.id})" class="w-8 h-8 rounded-lg bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Atualiza m√©tricas
            const bruto = db.vendas.reduce((a, b) => a + b.total, 0);
            const lucro = db.vendas.reduce((a, b) => a + b.lucro, 0);
            const inv = db.investimento || 0;
            document.getElementById('dashLucro').textContent = `R$ ${lucro.toFixed(2)}`;
            document.getElementById('faturacaoBruta').textContent = `R$ ${bruto.toFixed(2)}`;
            document.getElementById('roiDisplay').textContent = inv > 0 ? `${((lucro / inv) * 100).toFixed(1)}%` : '0%';
            document.getElementById('breakEvenStatus').textContent = lucro >= inv ? "Pago" : `Falta R$ ${(inv - lucro).toFixed(2)}`;
        }

        function abrirEditorVenda(id) {
            const venda = db.vendas.find(v => v.id === id);
            if(!venda) return;
            
            document.getElementById('editVendaId').value = venda.id;
            document.getElementById('editVendaData').value = venda.data;
            document.getElementById('editVendaTotal').value = venda.total;
            document.getElementById('editVendaLucro').value = venda.lucro;
            
            toggleModal('modalEditVenda');
        }

        function salvarEdicaoVenda() {
            const id = parseInt(document.getElementById('editVendaId').value);
            const novaData = document.getElementById('editVendaData').value;
            const novoTotal = parseFloat(document.getElementById('editVendaTotal').value);
            const novoLucro = parseFloat(document.getElementById('editVendaLucro').value);

            const idx = db.vendas.findIndex(v => v.id === id);
            if(idx !== -1) {
                db.vendas[idx].data = novaData;
                db.vendas[idx].total = novoTotal;
                db.vendas[idx].lucro = novoLucro;
                save();
                toggleModal('modalEditVenda');
                renderFinanceiro();
                showToast("Sucesso", "Venda atualizada");
            }
        }

        function excluirVenda(id) {
            const venda = db.vendas.find(v => v.id === id);
            if(!venda) return;

            if(confirm('Tem certeza que deseja EXCLUIR esta venda?\n\nO valor ser√° removido do caixa.')) {
                // Pergunta sobre o estoque
                if(confirm('Deseja DEVOLVER os itens ao estoque?\n\nClique em OK para repor os produtos.\nClique em Cancelar para apenas apagar o registro financeiro.')) {
                    venda.itens.forEach(item => {
                        const prod = db.estoque.find(p => p.id === item.prodId);
                        if(prod) {
                            prod.qtdUn += item.desconto; // item.desconto cont√©m a quantidade real retirada (1 ou pack size)
                        }
                    });
                    showToast("Estoque", "Itens devolvidos");
                }
                
                db.vendas = db.vendas.filter(v => v.id !== id);
                save();
                renderFinanceiro();
                showToast("Venda Exclu√≠da", "Registro removido");
            }
        }

        // --- PONTO ---
        function registarPonto(tipo) {
            const nome = document.getElementById('workerName').value;
            if(!nome) return showToast("Erro", "Insira o nome", "error");
            db.ponto.unshift({ nome, tipo, data: new Date().toLocaleString('pt-PT') });
            save();
            showToast("Ponto", `${nome} -> ${tipo}`);
        }

        function renderPontoLogs() {
            document.getElementById('pontoLogs').innerHTML = db.ponto.map(p => `
                <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <span class="text-[11px] font-bold">${p.nome}</span>
                    <div class="text-right">
                        <span class="block text-[8px] font-black ${p.tipo === 'ENTRADA' ? 'text-emerald-500' : 'text-red-500'}">${p.tipo}</span>
                        <span class="text-[9px] text-slate-500">${p.data}</span>
                    </div>
                </div>`).join('');
        }

        // --- CORE ---
        function save() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); 
            if(document.querySelector('.tab-content.active').id === 'financeiro') renderFinanceiro();
            refreshUI(); 
            updateStats();
        }

        function refreshUI() {
            renderCatalogo();
            // renderCarrinho(); // N√£o re-renderiza carrinho para n√£o perder estado visual se n√£o mudou
            renderPontoLogs();
            document.getElementById('gridEstoque').innerHTML = db.estoque.map(p => `
                <div class="bg-slate-900/50 p-5 rounded-2xl border border-white/5 relative group transition-all hover:bg-slate-900">
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button onclick="abrirEditarProduto(${p.id})" title="Editar" class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white flex items-center justify-center transition-all"><i class="fas fa-edit text-xs"></i></button>
                        <button onclick="if(confirm('Apagar ${p.nome}?')) { db.estoque = db.estoque.filter(x => x.id !== ${p.id}); save(); }" title="Apagar" class="w-8 h-8 rounded-lg bg-slate-800 text-slate-600 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all"><i class="fas fa-times text-xs"></i></button>
                    </div>
                    <p class="label-blue !mb-2 !ml-0 pr-20">${p.nome}</p>
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="block text-[8px] text-slate-500 font-black mb-1">STOCK</span>
                            <div class="flex items-center gap-1">
                                <button onclick="quickStockAction(${p.id}, 'remove')" class="w-6 h-6 rounded bg-slate-800 text-red-500 hover:bg-red-500/20 font-bold border border-white/5">-</button>
                                <span class="text-xl font-black min-w-[30px] text-center ${p.qtdUn <= 3 ? 'text-amber-400' : ''}">${p.qtdUn}</span>
                                <button onclick="quickStockAction(${p.id}, 'add')" class="w-6 h-6 rounded bg-slate-800 text-emerald-500 hover:bg-emerald-500/20 font-bold border border-white/5">+</button>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-[8px] text-slate-500 font-black">VENDA UN</span>
                            <span class="text-sm font-bold text-slate-400">R$ ${p.precoUn.toFixed(2)}</span>
                            ${p.packs && p.packs.length > 0 ? `<span class="block text-[8px] text-amber-400/60 font-bold">${p.packs.length} pack(s)</span>` : ''}
                        </div>
                    </div>
                </div>`).join('');
        }

        function updateInvestimento() {
            db.investimento = parseFloat(document.getElementById('invTotalInput').value) || 0;
            save();
        }

        function updateClock() { document.getElementById('liveClock').textContent = new Date().toLocaleTimeString('pt-PT'); }
        
        function showToast(msg, sub, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastSubMsg').textContent = sub;
            const icon = document.getElementById('toastIcon');
            icon.className = `w-8 h-8 rounded-full flex items-center justify-center ${type === 'success' ? 'bg-blue-500/20 text-blue-500' : type === 'warning' ? 'bg-amber-500/20 text-amber-500' : 'bg-red-500/20 text-red-500'}`;
            icon.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation' : 'times'} text-[10px]"></i>`;
            t.classList.remove('opacity-0', 'translate-y-20', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20', 'pointer-events-none'), 3000);
        }

        function updateStats() {
            document.getElementById('statProds').textContent = db.estoque ? db.estoque.length : 0;
            document.getElementById('statVendas').textContent = db.vendas ? db.vendas.length : 0;
            document.getElementById('statPonto').textContent = db.ponto ? db.ponto.length : 0;
        }

        // --- EDI√á√ÉO DE PRODUTO VIA MODAL ---
        let modalEditPacks = [];

        function abrirEditarProduto(id) {
            const p = db.estoque.find(x => x.id == id);
            if(!p) return;
            modalEditPacks = JSON.parse(JSON.stringify(p.packs || []));
            document.getElementById('modalEditProdId').value = p.id;
            document.getElementById('modalEditNome').value = p.nome;
            document.getElementById('modalEditCusto').value = p.custoUn;
            document.getElementById('modalEditPreco').value = p.precoUn;
            document.getElementById('modalEditQtd').value = p.qtdUn;
            document.getElementById('modalEntradaQtd').value = '';
            document.getElementById('modalNewPackUn').value = '';
            document.getElementById('modalNewPackPreco').value = '';
            renderModalPacks();
            toggleModal('modalEditProduto');
        }

        function renderModalPacks() {
            const cont = document.getElementById('modalPacksList');
            if(modalEditPacks.length === 0) {
                cont.innerHTML = `<p class="text-[9px] text-slate-500 text-center font-bold uppercase py-2">Sem packs configurados</p>`;
                return;
            }
            cont.innerHTML = modalEditPacks.map((pk, i) => `
                <div class="flex justify-between items-center bg-black/30 px-4 py-3 rounded-xl border border-white/5">
                    <div>
                        <span class="text-[10px] font-black text-amber-400">PACK ${pk.un}x</span>
                        <span class="text-[10px] text-slate-400 ml-2">R$ ${pk.preco.toFixed(2)}</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="number" value="${pk.preco}" onchange="modalEditPacks[${i}].preco = parseFloat(this.value)||0; renderModalPacks();" 
                            class="w-20 bg-slate-900 border border-white/10 rounded-lg px-2 py-1 text-[10px] text-center font-bold text-white outline-none focus:border-blue-500" step="0.01">
                        <button onclick="modalEditPacks.splice(${i},1); renderModalPacks();" class="w-7 h-7 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all">
                            <i class="fas fa-times text-[9px]"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function adicionarPackModal() {
            const un = parseInt(document.getElementById('modalNewPackUn').value);
            const preco = parseFloat(document.getElementById('modalNewPackPreco').value);
            if(!un || isNaN(preco) || preco <= 0) return showToast("Erro", "Preencha qtd e pre√ßo do pack", "error");
            if(modalEditPacks.find(p => p.un === un)) return showToast("Aviso", "Pack com essa qtd j√° existe", "warning");
            modalEditPacks.push({ un, preco });
            document.getElementById('modalNewPackUn').value = '';
            document.getElementById('modalNewPackPreco').value = '';
            renderModalPacks();
            showToast("Pack", `Pack ${un}x adicionado`);
        }

        function ajustarModalStock(delta) {
            const input = document.getElementById('modalEditQtd');
            const val = parseInt(input.value) || 0;
            input.value = Math.max(0, val + delta);
        }

        function entradaRapidaModal() {
            const qtd = parseInt(document.getElementById('modalEntradaQtd').value);
            if(!qtd || qtd <= 0) return showToast("Erro", "Insira uma quantidade v√°lida", "error");
            const currentQtd = document.getElementById('modalEditQtd');
            currentQtd.value = (parseInt(currentQtd.value) || 0) + qtd;
            document.getElementById('modalEntradaQtd').value = '';
            showToast("Entrada", `+${qtd} adicionado`);
        }

        function salvarEdicaoProduto() {
            const id = parseInt(document.getElementById('modalEditProdId').value);
            const nome = document.getElementById('modalEditNome').value.trim();
            const custoUn = parseFloat(document.getElementById('modalEditCusto').value) || 0;
            const precoUn = parseFloat(document.getElementById('modalEditPreco').value) || 0;
            const qtdUn = parseInt(document.getElementById('modalEditQtd').value) || 0;
            
            if(!nome) return showToast("Erro", "Nome obrigat√≥rio", "error");
            
            const idx = db.estoque.findIndex(p => p.id == id);
            if(idx !== -1) {
                db.estoque[idx] = { ...db.estoque[idx], nome, custoUn, precoUn, qtdUn, packs: [...modalEditPacks] };
                save();
                toggleModal('modalEditProduto');
                showToast("Produto Atualizado", nome);
            }
        }

        function resetSistema() {
            if(confirm('ATEN√á√ÉO: Voc√™ est√° prestes a apagar TODOS os dados do sistema (Estoque, Vendas, Ponto, Financeiro).\n\nEssa a√ß√£o n√£o pode ser desfeita.')) {
                const check = prompt('Para confirmar a exclus√£o completa, digite a palavra "DELETAR" abaixo:');
                if(check === 'DELETAR') {
                    db = { estoque: [], vendas: [], ponto: [], investimento: 0, config: { whatsapp: '' } };
                    save();
                    showToast("Sistema Resetado", "Todos os dados foram apagados", "error");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast("Cancelado", "C√≥digo de confirma√ß√£o incorreto", "error");
                }
            }
        }

        function exportarBackup() {
            const blob = new Blob([JSON.stringify(db)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CH_Geladas_BKP_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('lastBackupInfo').textContent = new Date().toLocaleString();
            showToast("Backup Criado", "Arquivo baixado");
        }

        function importarDados(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Resetamos o input para permitir selecionar o mesmo arquivo novamente caso haja erro
                    input.value = '';

                    if (data.estoque && Array.isArray(data.estoque)) {
                        if(confirm('ATEN√á√ÉO: Isso substituir√° TODOS os dados atuais pelos do arquivo.\n\nTem certeza que deseja continuar?')) {
                             // Mesclamos com o DB atual para garantir que chaves novas (como config do zap) n√£o quebrem com backups antigos
                             db = { ...db, ...data };
                             save();
                             showToast("Sucesso", "Dados restaurados!");
                             setTimeout(() => location.reload(), 1500);
                        }
                    } else {
                        showToast("Erro", "Arquivo inv√°lido ou corrompido", "error");
                    }
                } catch (err) {
                    input.value = '';
                    showToast("Erro", "Falha ao ler arquivo", "error");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        window.onload = init;
    </script>
    <script type="module" src="firebase.js"></script>

<script type="module" src="sync.js"></script>
</body>
</html>